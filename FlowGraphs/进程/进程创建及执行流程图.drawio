<mxfile host="65bd71144e">
    <diagram id="dCvuodsPiUNj7MBmJcpd" name="Page-1">
        <mxGraphModel dx="3995" dy="1722" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="49" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="2" target="3">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="2" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;【main.c】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;k_thread_a&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;u_prog_a&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; test_var_a &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;0;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;main&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; //略&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;&amp;nbsp; &amp;nbsp; thread_start&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #98c379;&quot;&gt;&quot;k_thread_a&quot;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;, k_thread_a, &lt;/span&gt;&lt;span style=&quot;color: #98c379;&quot;&gt;&quot;argA &quot;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;process_execute&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(u_prog_a, &lt;/span&gt;&lt;span style=&quot;color: #98c379;&quot;&gt;&quot;user_prog_a&quot;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; //略&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;k_thread_a&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; arg&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;char*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; para &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; arg;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;while&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;console_put_str&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(para);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;console_put_int&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(test_var_a);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;/*Now, we don&#39;t access file system,so,we use function to replace User-process.*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;u_prog_a&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;while&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; test_var_a&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;++&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="520" y="171" width="560" height="539" as="geometry"/>
                </mxCell>
                <mxCell id="16" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3" target="6" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="17" style="edgeStyle=none;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3" target="4" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="-715" y="916"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="61" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="3" target="60">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="3" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;【process.c】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;process_execute&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; filename&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;char*&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; name&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; task_struct&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; thread &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;get_kernel_pages&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;init_thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(thread, name, default_prio);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;create_user_vaddr_bitmap&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(thread);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;thread_create&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(thread, start_process, filename);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;pgdir&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;create_page_dir&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;enum&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; intr_status old_status &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;intr_disable&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;ASSERT&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(86, 182, 194);&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;elem_find&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;thread_ready_list, &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;general_tag&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;));&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;list_append&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;thread_ready_list, &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;general_tag&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;ASSERT&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(86, 182, 194);&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;elem_find&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;thread_all_list, &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;all_list_tag&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;));&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;list_append&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;thread_all_list, &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;all_list_tag&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;intr_set_status&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(old_status);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="547.5" y="761" width="505" height="310" as="geometry"/>
                </mxCell>
                <mxCell id="4" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;【process.c】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;create_user_vaddr_bitmap&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; task_struct&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; user_prog&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;user_prog&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;userprog_vaddr&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;vaddr_start&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; USER_VADDR_START;&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//userprog_vaddr is a virturl address pool manager, it include an bitmap and vaddr_start.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; bitmap_pg_cnt &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;DIV_ROUND_UP&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;c0000000&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; USER_VADDR_START) &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; PG_SIZE &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;8&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;, PG_SIZE);&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//!pay attention! The number of pages which are used to store the bitmap(Round up).&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;user_prog&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;userprog_vaddr&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;vaddr_bitmap&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;bits&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;get_kernel_pages&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(bitmap_pg_cnt);&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//get_kernel_pages()&#39;s return type is an void*, and bits type is uint8_t*.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;user_prog&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;userprog_vaddr&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;vaddr_bitmap&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;btmp_bytes_len&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;c0000000&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; USER_VADDR_START) &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; PG_SIZE &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;8&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;bitmap_init&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;user_prog&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;userprog_vaddr&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;vaddr_bitmap&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="-1130" y="1141" width="830" height="220" as="geometry"/>
                </mxCell>
                <mxCell id="6" value="&lt;div style=&quot;background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#c678dd&quot;&gt;【process.c】&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;create_page_dir&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;&amp;nbsp; &amp;nbsp; /*User can&#39;t visit User process&#39; PDT directly,so,we need create PDT in kernel memory pool.*/&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; page_dir_vaddr &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;get_kernel_pages&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (page_dir_vaddr &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;NULL&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;console_put_str&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #98c379;&quot;&gt;&quot;create_page_dir: get_kernel_page failed!&quot;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;NULL&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;&amp;nbsp; &amp;nbsp; /*Copy the PDEs which are point to the kernel to the new User-process&#39; PDT.*/&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;&amp;nbsp; &amp;nbsp; /*768th and above PDE all default point to kernel, (1023 - 768 + 1) * 1024 * 4KB = 1GB .*/&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;memcpy&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;)((&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;)page_dir_vaddr &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;300&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;), (&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;)(&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;fffff000&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;300&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;), &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;1024&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//(1023 - 768 + 1) * 4 = 1024, make sure all User-process can share the kernel.&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;&amp;nbsp; &amp;nbsp; /*Update the page directory&#39;s physical address.*/&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; new_page_dir_phy_addr &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;addr_v2p&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;)page_dir_vaddr);&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;&amp;nbsp; &amp;nbsp; /*The 1023th PDE store the physic address of PDT.*/&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;page_dir_vaddr&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;1023&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; new_page_dir_phy_addr &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;|&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; PG_US_U &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;|&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; PG_RW_W &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;|&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; PG_P_1;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; page_dir_vaddr;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="-180" y="1130" width="560" height="500" as="geometry"/>
                </mxCell>
                <mxCell id="7" value="&lt;font color=&quot;#4dff40&quot; style=&quot;font-size: 24px;&quot;&gt;当用户进程被初次换上处理器&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
                    <mxGeometry x="1957" y="-4" width="350" height="110" as="geometry"/>
                </mxCell>
                <mxCell id="26" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="8" target="10" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="58" style="edgeStyle=none;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="8" target="9">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="8" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;【switch.S】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;[bits &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;32&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;section .text&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;global switch_to&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;switch_to:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;;now, esp register point to the switch_to()&#39;s return address in cur&#39;s PCB&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;push&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;esi&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;push&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;edi&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;push&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;ebx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;push&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;ebp&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;mov&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;eax&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;, [&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;esp&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; + &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;20&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;] &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;;get the pointer of cur PCB&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;mov&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;eax&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;], &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;esp&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;;now, [eax] is the structure of task_struct&#39;s first element,yes, now the self_kstack store the esp&#39;s value(the top of thread_stack).&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;mov&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;eax&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;, [&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;esp&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; + &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;24&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;;get the next thread&#39;s PCB(self_stack)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;mov&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;esp&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;, [&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;eax&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;;next thread&#39;s self_stack point to the top of thread_stack.&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;pop&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;ebp&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;pop&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;ebx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;pop&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;edi&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;pop&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;esi&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;ret&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;;to execute objective function.&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fontSize=36;fontColor=#4DFF40;" parent="1" vertex="1">
                    <mxGeometry x="2400" y="1168" width="560" height="502" as="geometry"/>
                </mxCell>
                <mxCell id="9" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;【thread.h】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;thread_stack&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ebp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ebx;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; edi;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; esi;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;/*When thread first run,eip point to kernel_thread(), other time, eip point to the return address of suitch_to().*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (*&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;eip&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;)(&lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;thread_func&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;func&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;func_arg&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//&quot;eip&quot; is just a parameter name.&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;unused_retaddr);&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//placeholding&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; thread_func&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; function;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; func_arg;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;};&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fontSize=24;fontColor=#4DFF40;" parent="1" vertex="1">
                    <mxGeometry x="3150" y="1264" width="560" height="310" as="geometry"/>
                </mxCell>
                <mxCell id="65" style="edgeStyle=none;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="10" target="64">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="71" style="edgeStyle=none;html=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="10" target="69">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="10" value="&lt;div style=&quot;background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#c678dd&quot;&gt;【process.c】&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;start_process&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; filename_&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; function &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; filename_;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;//Address of User program.&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; task_struct&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; cur &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;running_thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;cur&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;self_kstack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;+=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; thread_stack);&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;//self_kstack point to the botton of kthread_stack now.&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; intr_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; proc_stack &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; intr_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;cur&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;self_kstack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;//use intr_stack sapce to store the User-program&#39;s context when first enter the User-program temporarily.&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;edi&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;esi&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;ebp&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;esp_dummy&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;ebx&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;edx&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;ecx&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;eax&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;gs&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;ds&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;es&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;fs&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; SELECTOR_U_DATA;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;eip&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; function;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;//the address of User-program which will be executed.&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;cs&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; SELECTOR_U_CODE;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;eflags&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; (EFLAGS_IOPL_0 &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;|&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; EFLAGS_MBS &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;|&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; EFLAGS_IF_1);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;esp&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)((&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;get_a_page&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(PF_USER, USER_STACK3_VADDR) &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; PG_SIZE);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;proc_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;ss&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; SELECTOR_U_DATA;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;asm&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;volatile&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;movl %0, %%esp; jmp intr_exit&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; : : &lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;g&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(proc_stack) : &lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;memory&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;//enter to the User&#39;s space which privilege level is 3.&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fontSize=24;fontColor=#4DFF40;" parent="1" vertex="1">
                    <mxGeometry x="2400" y="1710" width="560" height="500" as="geometry"/>
                </mxCell>
                <mxCell id="20" style="edgeStyle=none;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="11" target="12" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="1790" y="830"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="24" style="edgeStyle=none;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="11" target="8" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="2680" y="830"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="11" value="&lt;span style=&quot;color: rgb(198, 120, 221); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px;&quot;&gt;【thread.c】&lt;/span&gt;&lt;br&gt;&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;schedule&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;() {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;//replace current thread&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;ASSERT&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;intr_get_status&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; INTR_OFF);&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; task_struct&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; cur &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;running_thread&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;cur&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;status&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; TASK_RUNNING) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;ASSERT&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #56b6c2;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;elem_find&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;thread_ready_list, &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;cur&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;general_tag&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;));&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;list_append&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;thread_ready_list, &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;cur&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;general_tag&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;cur&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;ticks&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;cur&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;priority&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;cur&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;status&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; TASK_READY;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;//temporary empty&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;//change new thread which is the first element in thread_ready_list.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;ASSERT&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #56b6c2;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;list_empty&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;thread_ready_list));&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; thread_tag &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;NULL&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; thread_tag &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;list_pop&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;thread_ready_list);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; task_struct&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; next &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;elem2entry&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; task_struct, general_tag, thread_tag);&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; //general_tag is the name of member.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;next&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;status&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; TASK_RUNNING;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;&amp;nbsp; &amp;nbsp; /*Enable the task&#39;s page table and so on.*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;process_activate&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(next);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;switch_to&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(cur, next);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fontSize=24;fontColor=#4DFF40;" parent="1" vertex="1">
                    <mxGeometry x="1860" y="555" width="565" height="550" as="geometry"/>
                </mxCell>
                <mxCell id="22" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="12" target="13" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="23" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="12" target="14" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="12" value="&lt;div style=&quot;background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#c678dd&quot;&gt;【process.c】&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;process_activate&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; task_struct&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; p_thread&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;ASSERT&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(p_thread &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;!=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;NULL&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;page_dir_activate&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(p_thread);&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; //*Enable the page table.&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;p_thread&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;pgdir&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;!=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;NULL&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;update_tss_esp0&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(p_thread);&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(171, 178, 191);&quot;&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fontSize=24;fontColor=#4DFF40;" parent="1" vertex="1">
                    <mxGeometry x="1550" y="1168" width="480" height="160" as="geometry"/>
                </mxCell>
                <mxCell id="13" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;【process.c】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;page_dir_activate&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; task_struct&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; p_thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;&amp;nbsp; &amp;nbsp; /*If the current task is a kernel thread, then the PDT is the same as the kernel&#39;s PDT,else,we should change CR3&#39;s value.*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; pagedir_phy_addr &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;100000&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&amp;nbsp; //Kernel&#39;s PDT address&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;p_thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;pgdir&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;!=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;NULL&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) {&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; //jodge whether the current task is a kernel thread or a user process.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pagedir_phy_addr &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;addr_v2p&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;p_thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;pgdir&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; //translate PDT&#39;s virtual address to physical address.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;&amp;nbsp; &amp;nbsp; /*Reloade the CR3.*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;asm&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;volatile&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;movl %0, %%cr3&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; : : &lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(pagedir_phy_addr) : &lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;memory&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fontSize=24;fontColor=#4DFF40;" parent="1" vertex="1">
                    <mxGeometry x="1250" y="1457" width="560" height="270" as="geometry"/>
                </mxCell>
                <mxCell id="14" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;【tss.c】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;update_tss_esp0&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; task_struct&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; pthread&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;tss&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;esp0&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;)((&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;)pthread &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; PG_SIZE);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fontSize=24;fontColor=#4DFF40;" parent="1" vertex="1">
                    <mxGeometry x="1870" y="1458" width="460" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="29" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="27" target="2" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="27" value="&lt;font color=&quot;#4dff40&quot; style=&quot;font-size: 24px;&quot;&gt;用户进程的创建&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
                    <mxGeometry x="625" width="350" height="90" as="geometry"/>
                </mxCell>
                <mxCell id="33" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="30" target="31" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="30" value="&lt;font color=&quot;#4dff40&quot; style=&quot;font-size: 24px;&quot;&gt;用户进程的创建前的准备工作&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
                    <mxGeometry x="-1735" width="350" height="90" as="geometry"/>
                </mxCell>
                <mxCell id="34" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="31" target="32" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="31" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;【tss.c&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;tss_init&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;() {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;put_str&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;tss_init start&lt;/span&gt;&lt;span style=&quot;color: rgb(86, 182, 194);&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; tss_size &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(tss);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;memset&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;tss, &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;, tss_size);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;tss&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;ss0&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; SELECTOR_K_STACK;&amp;nbsp; //内核栈空间段选择子(也即数据段选择子)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;tss&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;io_base&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; tss_size;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; //it indicate don&#39;t have I/O bitmap.&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;&amp;nbsp; &amp;nbsp; /*GDT&#39;s segement base adress is 0x900, we set TSS descriptor to the forth position in GDT.*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; gdt_desc&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;c0000920&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;make_gdt_desc&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;tss, tss_size &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;, TSS_ATTR_LOW, TSS_ATTR_HIGH);&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;&amp;nbsp; &amp;nbsp; /*create user&#39;s descriptors about data segement and code segement.*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; gdt_desc&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;c0000928&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;make_gdt_desc&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;fffff&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;, GDT_CODE_ATTR_LOW_DPL3, GDT_ATTR_HIGH);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; gdt_desc&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;c0000930&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;make_gdt_desc&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;fffff&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;, GDT_DATA_ATTR_LOW_DPL3, GDT_ATTR_HIGH);&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;&amp;nbsp; &amp;nbsp; /*lgdt&#39;s structure: &amp;nbsp;`lgdt (16bit limit) (32bit GDT&#39;s segement base address)`*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint64_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; lgdt_operand &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; ((&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;8&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;7&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;|&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; ((&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint64_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;c0000900&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;16&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;));&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;// &quot; | &quot; is the operator of &quot;or&quot;.&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;asm&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;volatile&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;lgdt %0&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; : : &lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;m&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(lgdt_operand));&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;asm&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;volatile&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;ltr %w0&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; : : &lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(SELECTOR_TSS));&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;put_str&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;tss_init and ltr done&lt;/span&gt;&lt;span style=&quot;color: rgb(86, 182, 194);&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: rgb(152, 195, 121);&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="-1840" y="140" width="560" height="542" as="geometry"/>
                </mxCell>
                <mxCell id="32" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;【tss.c】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;static&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; gdt_desc &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;make_gdt_desc&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; desc_addr&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; limit&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint8_t&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; attr_low&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint8_t&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; attr_high&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; desc_base &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;)desc_addr;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; gdt_desc desc;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;desc&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;limit_low_word&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; limit &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;0000ffff&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;desc&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;base_low_word&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; desc_base &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;0000ffff&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;desc&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;base_mid_byte&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ((desc_base &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;00ff0000&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;16&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;desc&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;attr_low_byte&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint8_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;)(attr_low);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;desc&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;limit_high_attr_high&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (((limit &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;000f0000&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;16&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint8_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;)(attr_high));&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;desc&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;base_high_byte&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; desc_base &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;24&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; desc;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="-1840" y="740" width="560" height="270" as="geometry"/>
                </mxCell>
                <mxCell id="37" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="35" target="36" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="35" value="&lt;font color=&quot;#4dff40&quot; style=&quot;font-size: 24px;&quot;&gt;当发生时钟中断时&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
                    <mxGeometry x="3547" y="10" width="350" height="90" as="geometry"/>
                </mxCell>
                <mxCell id="36" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;① CPU自动从TR寄存器中获取TSS描述符&lt;br&gt;&lt;br&gt;② CPU由TSS描述符得到TSS物理地址&lt;br&gt;&lt;br&gt;③ CPU自动从TSS中得到当前进程的0特权级栈【即该进程PCB的最高地址】&lt;br&gt;&lt;br&gt;④ CPU将当前任务信息压入 intr_stack，且由于发生了特权级转变，因此也会将ss和esp寄存器值压入栈，&lt;b&gt;后续同线程切换&lt;/b&gt;&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" parent="1" vertex="1">
                    <mxGeometry x="3415.5" y="200" width="613" height="240" as="geometry"/>
                </mxCell>
                <mxCell id="38" value="" style="shape=singleArrow;whiteSpace=wrap;html=1;fontSize=18;" parent="1" vertex="1">
                    <mxGeometry x="-1160" y="10" width="1520" height="190" as="geometry"/>
                </mxCell>
                <mxCell id="39" value="" style="shape=singleArrow;whiteSpace=wrap;html=1;fontSize=18;" parent="1" vertex="1">
                    <mxGeometry x="1110" y="15" width="670" height="180" as="geometry"/>
                </mxCell>
                <mxCell id="40" value="" style="shape=singleArrow;whiteSpace=wrap;html=1;fontSize=18;" parent="1" vertex="1">
                    <mxGeometry x="2510" width="940" height="190" as="geometry"/>
                </mxCell>
                <mxCell id="42" style="edgeStyle=none;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="41" target="31" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="41" value="&lt;div style=&quot;color: #abb2bf;background-color: #23272e;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;/*the struct of TSS*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; tss {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; backlink;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; esp0;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ss0;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; esp1;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ss1;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; esp2;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ss2;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; cr3;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;eip) (&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;); &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; eflags;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; eax;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ecx;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; edx;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ebx;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; esp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ebp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; esi;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; edi;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; es;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; cs;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ss;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ds;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; fs;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; gs;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; idt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; trace;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; io_base;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;};&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;static&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; tss tss;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="-2180" y="106" width="220" height="610" as="geometry"/>
                </mxCell>
                <mxCell id="43" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;【thread.h】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;/*process or thread&#39;s PCB(program control block)*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;task_struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; self_kstack;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;pid_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; pid;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;enum&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;task_status&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;status&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;char&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;16&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;];&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint8_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; priority;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint8_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; ticks;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;//the piece of time (task running in CPU), one clock interrupt occured, ticks--.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; elapsed_ticks;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; //elapsed: have used.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;list_elem&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;general_tag&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;list_elem&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;all_list_tag&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; pgdir;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;//task is process, pgdir is the address of PDT, task is thread, pgdir is NULL.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;virtual_addr&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;userprog_vaddr&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;//each users&#39; viarual address pool manager.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;mem_block_desc&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;u_block_descs&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;[DESC_CNT];&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;//memory block descriptor for user-process, to aceieve heap-managing.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; stack_magic;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;//the boundary of stack,clock interrupt function will judge this value.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;};&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
                    <mxGeometry x="975" y="-360" width="930" height="350" as="geometry"/>
                </mxCell>
                <mxCell id="44" value="&lt;font color=&quot;#1d1c1c&quot; style=&quot;font-size: 48px;&quot;&gt;&lt;b style=&quot;&quot;&gt;PCB&lt;/b&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
                    <mxGeometry x="1355" y="-444" width="180" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="48" style="edgeStyle=none;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="46" target="4">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="46" value="&lt;div style=&quot;color: #abb2bf;background-color: #23272e;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;#define&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;USER_VADDR_START&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;8048000&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//The start address of User-process&#39;s virtual address space in Linux.&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
                    <mxGeometry x="-1120" y="1410" width="810" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="51" style="edgeStyle=none;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="50" target="14">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="50" value="&lt;font style=&quot;font-size: 18px;&quot;&gt;Pay attention: the pthread is the PCB of this thread or process in kernel, so we use this PCB&#39;s top to be the kernel-stack of this thread or process.&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
                    <mxGeometry x="1910" y="1607" width="380" height="120" as="geometry"/>
                </mxCell>
                <mxCell id="57" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="52" target="11">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="52" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;【timer.c】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; ticks;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;/*clock interrupt handler*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;static&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;intr_timer_handler&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; task_struct&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; cur_thread &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;running_thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;();&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;ASSERT&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;cur_thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;stack_magic&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;0x&lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;12345678&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;cur_thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;elapsed_ticks&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;++&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; ticks&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;++&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; //record ticks&#39;s happen times from first clock interrupt to now.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;cur_thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;ticks&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;schedule&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;();&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;cur_thread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;ticks&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;--&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
                    <mxGeometry x="1847.5" y="171" width="590" height="330" as="geometry"/>
                </mxCell>
                <mxCell id="56" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.482;entryY=0.005;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" source="7" target="52">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="63" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="60" target="62">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="60" value="&lt;div style=&quot;color: rgb(171, 178, 191); background-color: rgb(35, 39, 46); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;/*initlalize thread_stack*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(97, 175, 239);&quot;&gt;thread_create&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; task_struct&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; pthread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; thread_func&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; function&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt; func_arg&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;) {&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; //task_struct: struct of PCB&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;&amp;nbsp; &amp;nbsp; /*reserved space of intr_stack*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;pthread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;self_kstack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;-=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; intr_stack);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt;&amp;nbsp; &amp;nbsp; /*reserved space of thread_stack*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;pthread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;self_kstack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;-=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; thread_stack);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; thread_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; kthread_stack &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; thread_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;pthread&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;self_kstack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: rgb(127, 132, 142);&quot;&gt; &amp;nbsp;.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;kthread_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;eip&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; kernel_thread;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;kthread_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;function&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; function;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;kthread_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;func_arg&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; func_arg;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;kthread_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;ebp&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;kthread_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;ebx&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;kthread_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;esi&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(229, 192, 123);&quot;&gt;kthread_stack&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(224, 108, 117);&quot;&gt;edi&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(198, 120, 221);&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(209, 154, 102);&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(171, 178, 191);&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
                    <mxGeometry x="414" y="1130" width="910" height="242" as="geometry"/>
                </mxCell>
                <mxCell id="62" value="&lt;div style=&quot;color: #abb2bf;background-color: #23272e;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;static&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;kernel_thread&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;thread_func&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; function&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt; func_arg&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;&amp;nbsp; &amp;nbsp; /*after enter interrupt, CPU will close interrupt automatically,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;&amp;nbsp; &amp;nbsp; but our task&#39;s schedule is based on clock interrupt,so we need enable interrupt.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;&amp;nbsp; &amp;nbsp; */&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;intr_enable&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//set IF bit to 1,CPU begin to receive clock interrupt.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;function&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;(func_arg);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
                    <mxGeometry x="544" y="1440" width="650" height="140" as="geometry"/>
                </mxCell>
                <mxCell id="64" value="&lt;div style=&quot;color: #abb2bf;background-color: #23272e;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;/*This structure is used to store environment of process or thread when interrupt occured.*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e5c07b;&quot;&gt;intr_stack&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; {&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//just define this structure, operating system can use this space arbitrarily.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; vec_no;&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//vector number&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; edi;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; esi;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ebp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; esp_dummy;&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; //popad will igonre esp.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ebx;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; edx;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ecx;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; eax;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; gs;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; fs;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; es;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ds;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;&amp;nbsp; &amp;nbsp; /*Sitiuation: when interrupt occured, the privilige level has changed*/&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; err_code;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; (*&lt;/span&gt;&lt;span style=&quot;color: #e06c75;&quot;&gt;eip&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;) (&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; cs;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; eflags;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;void*&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; esp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;uint32_t&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; ss;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;};&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
                    <mxGeometry x="3050" y="1730" width="760" height="460" as="geometry"/>
                </mxCell>
                <mxCell id="68" style="edgeStyle=none;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="67" target="10">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="67" value="&lt;div style=&quot;color: #abb2bf;background-color: #23272e;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;#define&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;USER_STACK3_VADDR&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &amp;nbsp;(0xc0000000 - 0x1000)&lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt; &amp;nbsp;//The start address of User-process&#39;s stack in Linux.&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
                    <mxGeometry x="2285" y="2270" width="790" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="69" value="&lt;div style=&quot;color: #abb2bf;background-color: #23272e;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;section .text&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;global intr_exit&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #61afef;&quot;&gt;intr_exit:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;add&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;esp&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;;skip the number of interrupt&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;popad&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;pop&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;gs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;pop&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;fs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;pop&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;es&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;pop&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;ds&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;add&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d19a66;&quot;&gt;esp&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #7f848e;&quot;&gt;;skip the error_code or 0 in stack&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #abb2bf;&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #c678dd;&quot;&gt;iret&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
                    <mxGeometry x="1670" y="1975" width="393" height="220" as="geometry"/>
                </mxCell>
                <mxCell id="72" value="利用intr_exit将带运行进程的上下文环境加载进寄存器中" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
                    <mxGeometry x="2130" y="1975" width="160" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="76" style="edgeStyle=none;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="74" target="69">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="74" value="从中断返回的指令是 iret(interrupt ret)，它从栈中弹出数据到寄存器 cs、eip、eflags 等，根据特权级是否改变，判断是否要恢复旧栈，也就是说是否将栈中位于 SS_old 和 ESP_old 位置的值弹出到寄存 ss 和 esp。当中断处理程序执行完成返回后，通过 iret 指令从栈中恢复 eflags 的内容" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
                    <mxGeometry x="1666.5" y="2240" width="400" height="90" as="geometry"/>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
</mxfile>